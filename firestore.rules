
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // --- Public Read-Only Collections ---
    match /courses/{courseId} {
      allow read: if true;
      allow write: if false;
    }
    
    match /blogPosts/{slug} {
      allow read: if true;
      allow write: if false; 
    }

    match /faqs/{faqId} {
        allow read: if true;
        allow write: if false;
    }
    
    match /quizSets/{setId} {
        allow read: if true;
        allow write: if false;
    }
    
    match /siteBanners/{bannerId} {
      allow read: if true;
      allow write: if false;
    }

    match /promotionalPosters/{posterId} {
        allow read: if true;
        allow write: if false;
    }

    // --- User-Specific Collections ---
    match /customers/{userId} {
      // Allow a user to create their own profile document.
      allow create: if isOwner(userId);
      // Allow a user to read and update their own document.
      allow read, update: if isAuthenticated() && isOwner(userId);
      // Prevent users from deleting their own accounts through the client.
      allow delete: if false;
    }
    
    match /trainers/{userId} {
      // Allow a user to create their own profile document.
      allow create: if isOwner(userId);
      // Allow a user to read and update their own document.
      allow read, update: if isAuthenticated() && isOwner(userId);
      // Prevent users from deleting their own accounts through the client.
      allow delete: if false;
    }

    // --- Other Collections (Default to Locked Down) ---
    // These collections should only be written to by admins or server-side logic.
    match /lessonRequests/{requestId} {
      allow read, write: if isAuthenticated(); // Allow logged-in users to manage their requests
    }

    match /rescheduleRequests/{requestId} {
      allow read, write: if isAuthenticated();
    }
    
    match /feedback/{feedbackId} {
        allow read, write: if isAuthenticated();
    }
    
    match /referrals/{referralId} {
        allow read, write: if isAuthenticated();
    }
  }
}
